<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--This maintains the scale of the page based on the scale of the screen-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--This liquid tag loads all of the necessary css files for HomeSeer-->
	
    {{includefile '/bootstrap/css/page_common.css'}}
    <title>InfluxDB Persistence</title>
	
    <link href="/css/hs.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="/HSPI_InfluxDBPersistence/datatables.min.css"/>
	<link rel="stylesheet" type="text/css" href="/HSPI_InfluxDBPersistence/metricsgraphics.css"/>
</head>

	{{
	refId=queries['refId'] ?? ""
	feature=queries['feature'] ?? ""
	displaySelect=queries['displaySelect'] ?? ""
	displayPeriod=queries['displayPeriod'] ?? ""

	periodStart=queries['periodStart'] ?? ""
	periodEnd=queries['periodEnd'] ?? ""
	
	if feature != ""
		finalRefId=feature
	else
		finalRefId=refId
	end		
	
	deviceDisplayDetails=plugin_function 'HSPI_InfluxDBPersistence' 'GetAllowedDisplays' [finalRefId]	 
		
	if displaySelect=="" && deviceDisplayDetails && !deviceDisplayDetails.empty?
		element=array.first deviceDisplayDetails
		displayType="table"
		displayTypes=element['displayTypes']
		
		if array.contains displayTypes "chart"
			displayType="chart"
		end	
	
		displaySelect=element['refId']+ '.' + displayType
	end
		
	}}	
	
	
<body class="body homeseer-skin ml-0 mr-0" aria-busy="true">	
<div class=".container-fluid"> 
{{options=displaySelect | regex.split `\.` }}
{{if options.size == 2}}
	{{
		rangeOptionsForTable=[ 
						 ["Last 10 values", "10", "", "last10values"], 
					 ]
									 
		rangeOptionsForOthers=[ 
						 ["1 hour", "", "01:00:00", "1hr"],
						 ["6 hours", "", "06:00:00", "6hr"],
						 ["1 day", "", "1.00:00:00", "1d"],
						 ["7 days", "", "7.00:00:00", "7d"],
						 ["30 days", "", "30.00:00:00", "30d"],
						 ["90 days", "", "90.00:00:00", "90d"],
						 ["365 days", "", "365.00:00:00", "365d"],
					 ]
									
		if options[1]=="table"
			rangeOptions = rangeOptionsForTable | array.concat rangeOptionsForOthers
		else
			rangeOptions = rangeOptionsForOthers
		end		
		
		rangeOptionFound = false
		for rangeOption in rangeOptions
			if rangeOption[3]==displayPeriod
				rangeOptionFound=true
				break
			end
		end

		if !rangeOptionFound
			displayPeriod = rangeOptions[0][3]
		end	
	}}

	<nav class="navbar">
		<form class="form-inline my-0 mx-0" action="/HSPI_InfluxDBPersistence/feature.html" method="GET">	
			<input type="hidden" id="refId" name="refId" value="{{refId}}"> 
			<input type="hidden" id="feature" name="feature" value="{{feature}}"> 
			
			
			<input type="hidden" id="periodStart" name="periodStart" value="{{periodStart}}">
			<input type="hidden" id="periodEnd" name="periodEnd" value="{{periodEnd}}">
			
			<div class="md-form my-0 ml-0 mr-3">
				<select id="displaySelect" class="mdb-select md-form md-outline colorful-select dropdown-primary" name="displaySelect">
					{{ for item in deviceDisplayDetails }}				
						{{ for displayType in item["displayTypes"] }}
							{{thisOptionDisplaySelect=item["refId"] + "." + displayType}}
							<option value="{{thisOptionDisplaySelect}}" {{if thisOptionDisplaySelect==displaySelect;}}selected{{end}}>
							{{
							if deviceDisplayDetails.size > 1
								item["name"] + " - "
							end
							case displayType
								when "table"
									"Table"
								when "chart"
									"Chart"
								when "averageStats"
									"Average Stats"
								when "histogram"
									"Histogram"
								else
									"Unknown"
							end														
							}}</option>	
						{{end}}				 
					{{ end }}
				</select> 
			</div>	
			
			<div class="md-form my-0 ml-0 mr-3">
				<select id="displayPeriod" class="mdb-select md-form md-outline colorful-select dropdown-secondary" name="displayPeriod">
					{{for rangeOption in rangeOptions}}
						<option value="{{rangeOption[3]}}" {{if rangeOption[3]==displayPeriod;}}selected{{end}}>{{rangeOption[0]}}</option>	
					{{end}}			
				</select> 
			</div>

		</form>
	</nav>	  

	{{
		recordLimit = ""
		duration = ""
	
		for rangeOption in rangeOptions
			if rangeOption[3]==displayPeriod
				recordLimit=rangeOption[1]
				duration=rangeOption[2]
				break
			end
		end
	}}

	{{needDataTables=false}}
	{{if options[1]=="table"}}
		<table id="dt-persistence" class="table table-sm mb-0"cellspacing="0" width="100%">
			{{plugin_function 'HSPI_InfluxDBPersistence' 'BuildHistoryTableData' [options[0], recordLimit, duration]}}
		<table>		
		{{needDataTables=true}}
	{{else if options[1]=="chart"}}
		<div id='chartGraph2' align="center"></div> 
		<!-- <table align="center" class="table"> -->
			<!-- <tr><td id='chartGraph2' align="center"></td>  -->
		<!-- </table>  -->
		{{plugin_function 'HSPI_InfluxDBPersistence' 'BuildChartData' [options[0], recordLimit, duration] }}
	{{else if options[1]=="averageStats"}}
		<table id="dt-persistence" class="table table-sm" width="100%">
			{{plugin_function 'HSPI_InfluxDBPersistence' 'BuildAverageStatsData' [options[0], recordLimit, duration] }}
		<table>		
		{{needDataTables=true}}	
	{{end}}
	
{{else}}
{{displaySelect}}
No data	
	
{{end}}

</div>
 
{{includefile 'bootstrap/js/page_common.js'}}
<script type="text/javascript" src="/HSPI_InfluxDBPersistence/iframeResizer.contentWindow.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

{{if needDataTables}}
<script type="text/javascript" src="/HSPI_InfluxDBPersistence/datatables.min.js"></script>
{{end}}

{{if options[1]=="chart"}}
<script type="text/javascript" src="/HSPI_InfluxDBPersistence/d3.min.js"></script>
<script type="text/javascript" src="/HSPI_InfluxDBPersistence/metricsgraphics.min.js"></script>

{{end}}

<script>
$(function() {
    $('#displaySelect').change(function() {
        this.form.submit();
    });	
	
    $('#displayPeriod').change(function() {
        this.form.submit();
    });	
});

{{if needDataTables}}

function setUpPersistanceTable() {
  $('#dt-persistence').dataTable({
	'order': [],
	'paging': false,
  });
  
  // the following may break in future
  $('#dt-persistence_wrapper').find('label').each(function () {
    $(this).parent().append($(this).children());
  });
  $('#dt-persistence_wrapper .dataTables_filter').find('input').each(function () {
    const $this = $(this);
    $this.attr("placeholder", "Search");
    $this.removeClass('form-control-sm');
  });
  $('#dt-persistence_wrapper .dataTables_length').addClass('d-flex flex-row');
  $('#dt-persistence_wrapper .dataTables_filter').addClass('md-form').addClass('my-0');
  $('#dt-persistence_wrapper select').removeClass('custom-select custom-select-sm form-control form-control-sm');
  $('#dt-persistence_wrapper select').addClass('mdb-select');
  $('#dt-persistence_wrapper .mdb-select').materialSelect();
  $('#dt-persistence_wrapper .dataTables_filter').find('label').remove();
}

$(document).ready(function () {
	setUpPersistanceTable();
});	
{{else if options[1]=="chart"}}


function setUpChart() {
 var chartDataFromDB = chartData();
 var graph = MG.data_graphic({
                    data: chartDataFromDB,
                    target: document.getElementById('chartGraph2'),
                    x_extended_ticks: true,             
                    area: true,
                    interpolate: d3.curveMonotoneX,
                    min_y_from_data: true,
                    color: '#329de4',
                    x_rollover_format: function(d) { return d.date.toLocaleString() + ' '; },
					title:'{{plugin_function 'HSPI_InfluxDBPersistence' 'GetDisplayName' [options[0]]}}',
					full_width: true,
					// full_height: true,
					width: 300,
					height: 500,
				 });


}

$(document).ready(function () {
	setUpChart();
});

$( window ).resize(function() {
    setUpChart();
});
			 	
{{end}}
</script>
</body>
</html>
